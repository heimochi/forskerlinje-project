
---
title: "Preprocessing Pipeline"
format: html
execute:
  echo: true
---

```{r setup}
source("preprocess/shared/utilities.r") #small helpers
source("preprocess/shared/00_consent.R") # load_consent()
source("preprocess/shared/01_filter.r") # filter_clinical_data()
# load consent
consent <- load_consent()
```

```{r}
#| label: preprocess-atq-only
source("preprocess/bai/00_load_data.r")  # creates ATQ
REGT <- filter_clinical_data(REGT, consent_df = consent)


source("cope/scripts/preprocess/shared/02_data_types.r")

source("cope/scripts/preprocess/shared/03_handle_missing.r")

source("cope/scripts/preprocess/atq/04_score_atq.r")

write.csv(data, "outputs/atq_f.csv", row.names = FALSE)

```






?? wrap each questionnaire in a function for automation: would b cool
```{r}
# instruments
qes <- c("atq", "bai", "bdi", "iip", "mcq", "pswq", "regp", "regt", "scl")


run_pipeline <- function(q_name, load_path, score_script, output_name) {
  source(load_path)
  data <- get(q_name)
  source("scripts/shared/01_merge_consent.R")
  source("scripts/shared/02_filter_data.R")
  source("scripts/shared/03_handle_missing.R")
  source(score_script)
  write.csv(data, paste0("outputs/", output_name, ".csv"), row.names = FALSE)
}

run_pipeline("BDI", "scripts/bdi/00_load.R", "scripts/bdi/04_score_bdi.R", "bdi_f")
run_pipeline("ATQ", "scripts/atq/00_load.R", "scripts/atq/04_score_atq.R", "atq_f")
```