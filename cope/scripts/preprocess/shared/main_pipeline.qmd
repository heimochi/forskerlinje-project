---
title: "Preprocessing Pipeline"
format: html
execute:
echo: true
---

```{r setup}
source("preprocess/shared/path.r")                  # data_dir
source("preprocess/shared/utilities.r")             # small helpers
source("preprocess/shared/00_consent.R")            # load_consent()
source("preprocess/shared/01_filter.r")             # filter_clinical_data()
source("preprocess/shared/02_data_types.r")         # data_types(), check_types()
source("preprocess/shared/03_merge.r", echo = TRUE, verbose = TRUE)              # merge_instruments()

consent <- load_consent()
qes <- c("ATQ", "BAI", "BDI", "IIP", "MCQ", "PSWQ", "REGT", "SCL") #regp not a part yet  
```

```{r}
run_pipeline <- function(q_name, load_path) {
  source(load_path)
  data <- get(q_name)
  data <- filter_clinical_data(data, consent_df = consent, verbose = FALSE)
  data <- data_types(data)

  print(summary(data))                    # check
  invisible(data)                         # return silently
}
```

```{r}
# check
atq_clean <- run_pipeline("ATQ", "preprocess/atq.r")
bai_clean <- run_pipeline("BAI", "preprocess/bai.r")
```

```{r}
# Loop through all
all_data <- lapply(qes, function(q) {
  run_pipeline(q, paste0("preprocess/", tolower(q), ".r"))
})
names(all_data) <- qes
```

```{r}
merged_all <- merge_instruments(list(
  bai = BAI,
  atq = ATQ,
  bdi = BDI,
  iip = IIP,
  mcq = MCQ,
  pswq = PSWQ,
  scl = SCL,
  regp = REGP,
  regt = REGT
), verbose = TRUE)

```
