---
title: "mcq"
author: "mochibear"
format: html
editor: source
---

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
```

# Load data

```{r}
data_dir <- "/Users/maggieheimvik/Desktop/COPE/data/dataset"
data <- read_csv(file.path(data_dir, "clean/filtered/mcq.csv")) 
```

# check dataset
```{r}
#View(data)
cat("Unique people:", n_distinct(data$respondent_id), "\n")
colnames(data)
str(data)
summary(data)
```

#define dataset
```{r}
# dimensions are cognitive confidence, Positive Beliefs about worry, Cognitive Self-Consciousness, Negative beliefs about uncontrollability and danger, Beliefs about need to control thought

data <- data %>%
  select(
    respondent_id,
    assessment_context_label,
    treatment_id,
    mcq_cc = calculation_mcq_30_cc,
    mcq_pos = calculation_mcq_30_pos,
    mcq_csc = calculation_mcq_30_csc,
    mcq_neg = calculation_mcq_30_neg,
    mcq_nc = calculation_mcq_30_nc,
    mcq_total = calculation_mcq_30_total
  ) %>%
  mutate(
    respondent_id = as.numeric(respondent_id),
    treatment_id = as.numeric(treatment_id),
    across(c(mcq_cc, mcq_pos, mcq_csc, mcq_neg, mcq_nc, mcq_total), as.numeric),
    assessment_context_label = factor(
      assessment_context_label,
      levels = c("Assessment", "Admission", "Post-treatment")
    )
  )

mcq_subscales <- c(
  "mcq_cc",
  "mcq_pos",
  "mcq_csc",
  "mcq_neg",
  "mcq_nc"
)
```

# outliers
```{r}
rows_to_delete <- data %>%
  filter(
    is.na(mcq_total) |
    mcq_total <= 10 |  # Remove obvious zeros/errors
    !if_all(all_of(mcq_subscales), ~ .x >= 0 & .x <= 24)  # Subscales out of range
  )

cat("Rows to be deleted:", nrow(rows_to_delete), "\n\n")
View(rows_to_delete)

# Filter out impossible values
data <- data %>%
  filter(
    !is.na(mcq_total),
    mcq_total > 10,  # Remove only obvious zeros/errors
    if_all(all_of(mcq_subscales), ~ .x >= 0 & .x <= 24)
  )
```

# check range
```{r}
#mcq items are rated 1-4, with 8 items per subscale
summary(data$mcq_total)

#each item is 1-4
summary(data[mcq_subscales])
```

```{r}
# Calculate missingness for each column
missing_summary <- data %>%
  summarise(across(everything(), ~ sum(is.na(.)) / n() * 100)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "pct_missing")

# Plot
ggplot(missing_summary, aes(x = reorder(variable, -pct_missing), y = pct_missing)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = sprintf("%.1f%%", pct_missing)), 
            vjust = -0.5, size = 3) +
  labs(
    title = "mcq - Missing Data by Variable",
    x = "Variable",
    y = "% Missing"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

#final
```{r}
data <- data %>%
  select(-mcq_total)
cat("Unique people:", n_distinct(data$respondent_id), "\n")
cat("Rows:", nrow(data), "\n")
cat("Columns:", paste(colnames(data), collapse = ", "), "\n\n")

cat("Assessment contexts:\n")
table(data$assessment_context_label, useNA = "always")

View(data)
```

```{r}
write_csv(data, file.path(data_dir, "clean/mcq.csv"))
```

```{r}
```


```{r}
```
