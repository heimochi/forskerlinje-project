---
title: "scl"
author: "mochibear"
format: html
editor: source
---

```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
```

# Load data

```{r}
data_dir <- "/Users/maggieheimvik/Desktop/COPE/data/dataset"
data <- read_csv(file.path(data_dir, "clean/filtered/scl.csv")) 
```

# check dataset
```{r}
#View(data)
cat("Unique people:", n_distinct(data$respondent_id), "\n")
colnames(data)
#str(data)
#summary(data)
```

#define dataset
```{r}
#dimensions are Somatization, Obsessive-Compulsive, Interpersonal Sensitivity, Depression, Anxiety, Hostility, Phobic Anxiety, Paranoid Ideation, and Psychoticism

data <- data %>%
  select(
    respondent_id,
    assessment_context_label,
    treatment_id,
    respondent_gender,  # select corrrect t score
    
    # t scores by gender
    scl_somatization_t_f = calculation_somatisering_t_female,
    scl_somatization_t_m = calculation_somatisering_t_male,
    scl_obsessive_t_f = calculation_tvangssymptomer_t_female,
    scl_obsessive_t_m = calculation_tvangssymptomer_t_male,
    scl_interpersonal_t_f = calculation_interpersonlig_t_female,
    scl_interpersonal_t_m = calculation_interpersonlig_t_male,
    scl_depression_t_f = calculation_depresjon_t_female,
    scl_depression_t_m = calculation_depresjon_t_male,
    scl_anxiety_t_f = calculation_angst_t_female,
    scl_anxiety_t_m = calculation_angst_t_male,
    scl_hostility_t_f = calculation_fiendtlighet_t_female,
    scl_hostility_t_m = calculation_fiendtlighet_t_male,
    scl_phobic_t_f = calculation_fobisk_t_female,
    scl_phobic_t_m = calculation_fobisk_t_male,
    scl_paranoid_t_f = calculation_paranoid_t_female,
    scl_paranoid_t_m = calculation_paranoid_t_male,
    scl_psychoticism_t_f = calculation_psykotisisme_t_female,
    scl_psychoticism_t_m = calculation_psykotisisme_t_male
  )

```

#check ranges
```{r}
# Check ranges (T-scores should be ~30-80)
summary(data)
```
select correct tscore per person
```{r}
#female/male/if unknown then average of F and M
data <- data %>%
  mutate(
    scl_somatization = case_when(
      respondent_gender == "female" ~ scl_somatization_t_f,
      respondent_gender == "male" ~ scl_somatization_t_m,
      respondent_gender == "unknown" ~ (scl_somatization_t_f + scl_somatization_t_m) / 2
    ),
    scl_obsessive = case_when(
      respondent_gender == "female" ~ scl_obsessive_t_f,
      respondent_gender == "male" ~ scl_obsessive_t_m,
      respondent_gender == "unknown" ~ (scl_obsessive_t_f + scl_obsessive_t_m) / 2
    ),
    scl_interpersonal = case_when(
      respondent_gender == "female" ~ scl_interpersonal_t_f,
      respondent_gender == "male" ~ scl_interpersonal_t_m,
      respondent_gender == "unknown" ~ (scl_interpersonal_t_f + scl_interpersonal_t_m) / 2
    ),
    scl_depression = case_when(
      respondent_gender == "female" ~ scl_depression_t_f,
      respondent_gender == "male" ~ scl_depression_t_m,
      respondent_gender == "unknown" ~ (scl_depression_t_f + scl_depression_t_m) / 2
    ),
    scl_anxiety = case_when(
      respondent_gender == "female" ~ scl_anxiety_t_f,
      respondent_gender == "male" ~ scl_anxiety_t_m,
      respondent_gender == "unknown" ~ (scl_anxiety_t_f + scl_anxiety_t_m) / 2
    ),
    scl_hostility = case_when(
      respondent_gender == "female" ~ scl_hostility_t_f,
      respondent_gender == "male" ~ scl_hostility_t_m,
      respondent_gender == "unknown" ~ (scl_hostility_t_f + scl_hostility_t_m) / 2
    ),
    scl_phobic = case_when(
      respondent_gender == "female" ~ scl_phobic_t_f,
      respondent_gender == "male" ~ scl_phobic_t_m,
      respondent_gender == "unknown" ~ (scl_phobic_t_f + scl_phobic_t_m) / 2
    ),
    scl_paranoid = case_when(
      respondent_gender == "female" ~ scl_paranoid_t_f,
      respondent_gender == "male" ~ scl_paranoid_t_m,
      respondent_gender == "unknown" ~ (scl_paranoid_t_f + scl_paranoid_t_m) / 2
    ),
    scl_psychoticism = case_when(
      respondent_gender == "female" ~ scl_psychoticism_t_f,
      respondent_gender == "male" ~ scl_psychoticism_t_m,
      respondent_gender == "unknown" ~ (scl_psychoticism_t_f + scl_psychoticism_t_m) / 2
    ) 
  ) %>%
      select(respondent_id, assessment_context_label,treatment_id, scl_somatization, scl_obsessive, scl_interpersonal, scl_depression,scl_anxiety, scl_hostility, scl_phobic,scl_paranoid,scl_psychoticism)

# Check result
summary(data)

```
#missingness
```{r}
colSums(is.na(data))

#check where is missing
missing_rows <- data %>%
  filter(if_any(c(scl_somatization, scl_obsessive, scl_interpersonal, 
                  scl_depression, scl_anxiety, scl_hostility, 
                  scl_phobic, scl_paranoid, scl_psychoticism), is.na))

View(missing_rows)
# two rows: respondent 3530 and 3633

#remove the rows
data <- data %>%
  filter(if_all(c(scl_somatization, scl_obsessive, scl_interpersonal, 
                  scl_depression, scl_anxiety, scl_hostility, 
                  scl_phobic, scl_paranoid, scl_psychoticism), ~ !is.na(.)))

```

```{r}
# Calculate missingness for each column
missing_summary <- data %>%
  summarise(across(everything(), ~ sum(is.na(.)) / n() * 100)) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "pct_missing")

# Plot
ggplot(missing_summary, aes(x = reorder(variable, -pct_missing), y = pct_missing)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = sprintf("%.1f%%", pct_missing)), 
            vjust = -0.5, size = 3) +
  labs(
    title = "mcq - Missing Data by Variable",
    x = "Variable",
    y = "% Missing"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

#data types
```{r}
data <- data %>%
  mutate(
    respondent_id = as.numeric(respondent_id),
    treatment_id = as.numeric(treatment_id),
    across(starts_with("scl_"), as.numeric),
    assessment_context_label = factor(
      assessment_context_label,
      levels = c("Assessment", "Admission", "Post-treatment")
    )
  )

data <- data %>%
  mutate(across(starts_with("scl_"), ~round(.x, 0)))
```

#final
```{r}
cat("Unique people:", n_distinct(data$respondent_id), "\n")
cat("Rows:", nrow(data), "\n")
cat("Columns:", paste(colnames(data), collapse = ", "), "\n\n")

cat("Assessment contexts:\n")
table(data$assessment_context_label, useNA = "always")

View(data)
```


```{r}
write_csv(data, file.path(data_dir, "clean/scl.csv"))
```


```{r}
```

```{r}
```


```{r}
```

```{r}
```


```{r}
```

```{r}
```


```{r}
```

```{r}
```

```{r}
```

